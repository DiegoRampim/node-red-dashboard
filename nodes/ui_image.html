<script type="text/javascript">
    RED.nodes.registerType('ui_image', {
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {
                type: 'ui_group',
                required: false
            },
            name: {
                value: ''
            },
            width: {
                value: 0,
                validate: function (v) {
                    var valid = true

                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error", !valid);

                    return valid;
                }
            },
            height: {
                value: 0
            },
            file: {},
            path: {},
            layout: {
                value: 'adjust'
            }
        },
        inputs: 1,
        icon: "ui_image.png",
        paletteLabel: 'image',
        label: function () {
            return this.name || 'image';
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var that = this;

            $("#upload-file").hide();
            $("#image-preview").hide();


            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });


            if (that.path != undefined) {
                getListImages(that.path.ref);
            }else{
                getListImages(undefined);
            }           

            function getListImages(selected) {

                $.get('/uiimage', function (data) {

                    var found = false;

                    data.object.forEach(function (element) {

                        var category = element.name;
                        var numItem = element.list.length;

                        var optgroup = $('<optgroup>');
                        optgroup.attr('label', category);

                        element.list.forEach(function (item) {

                            var option = $("<option></option>");

                            if (selected == (category + '/' + item)) {
                                option = $("<option selected></option>");
                                found = true;
                            }

                            option.val(category + '/' + item);
                            option.text(item);

                            optgroup.append(option);

                        });

                        $("#node-input-file").append(optgroup);

                        if (found) {
                            $("#node-input-link").val(that.path.path);
                            $("#image-preview").attr('src', that.path.path).show();
                        }

                    });

                    data.listCat.forEach(function (category) {

                        var option = $("<option></option>");
                        option.val(category);
                        option.text(category);

                        $("#node-input-category").append(option);

                    });

                });

            }

            $("#node-input-file").change(function () {
                var value = $('#node-input-file').val();

                if (value != null) {
                    var url = '/uiimage/' + value;
                    $("#node-input-link").val(url);
                    $("#image-preview").attr('src', url).show();

                    that.path = {
                        path: url,
                        ref: value
                    };
                }
            });

            $("#bt-remove-image").click(function () {
                var value = $('#node-input-file').val();

                var newUrl = "/uiimage/" + value;

                $.ajax({
                    url: newUrl,
                    type: 'DELETE',
                    cache: false,
                    processData: false, // Don't process the files
                    contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                    success: function (data, textStatus) {
                        getListImages(undefined);
                        that.path = null;
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('ERRORS: ' + errorThrown);
                    }
                });


            });

            $("#bt-add-new-image").click(function () {
                $("#upload-file").show();
                $("#new-category").hide();
                $("#div-file").hide();
            });

            var setNewCategory = false;
            var lockUpload = false;

            $("#bt-add-new-category").click(function () {
                $("#new-category").show();
                $("#div-category").hide();

                setNewCategory = true;
            });

            $("#node-input-newCategory").focusout(function () {
                if (setNewCategory) {
                    let value = $("#node-input-newCategory").val();

                    if (value != null && value != '') {
                        $("#node-input-newCategory").removeClass("input-error");
                        lockUpload = false;
                        return;
                    }

                    $("#node-input-newCategory").addClass("input-error");
                    lockUpload = true;
                }
            });

            var files;

            $("#node-input-upload").on('change', prepareUpload);

            function prepareUpload(event) {
                files = event.target.files;
            }

            $("#bt-upload").click(uploadFiles);

            function uploadFiles(event) {

                if (lockUpload) {
                    return;
                }

                let category = $("#node-input-category").val();
                let newCategory = $("#node-input-newCategory").val();

                if (setNewCategory) {
                    category = newCategory;
                }

                event.stopPropagation(); // Stop stuff happening
                event.preventDefault(); // Totally stop stuff happening

                // Create a formdata object and add the files
                var data = new FormData();

                $.each(files, function (key, value) {
                    data.append(key, value);
                });

                data.append("category", category);

                var link = "/uiimage/" + category + "/" + files[0].name;

                $.ajax({
                    url: link,
                    type: 'POST',
                    data: data,
                    cache: false,
                    processData: false, // Don't process the files
                    contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                    success: function (data, textStatus) {
                        $("#node-input-upload").val('');

                        that.path = data;

                        getListImages(data.ref);

                        $("#node-input-link").val(data.path);

                        $("#upload-file").hide();

                        $("#image-preview").attr('src', data.path).show();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('ERRORS: ' + errorThrown);
                    }
                });
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="ui_image">

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row" id="template-row-group">
        <label for="node-input-group">
            <i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>

    <div class="form-row" id="template-row-size">
        <label>
            <i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>

    <!-- Layout -->
    <div class="form-row">
        <label>
            <i class="fa fa-th-large"></i> Layout</label>

        <select style="width:70%" id="node-input-layout">
            <option value="adjust">Adjust</option>
            <option value="center">Center</option>
            <option value="expand">Expand</option>
            <option value="side">Side by Side</option>
        </select>
    </div>
    <!-- Layout -->

    <!-- List -->
    <div id="div-file" class="form-row">
        <label for="node-input-file">
            <i class="fa fa-file-image-o"></i> File</label>

        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">

            <div style="position: absolute; left: 0px; right: 50px;">
                <select style="width:100%" id="node-input-file">
                    <option></option>
                </select>
            </div>

            <div class="btn-group" style="position: absolute; right: 0px; top: 0px;">
                <a class="editor-button" data-toggle="dropdown">
                    <i class="fa fa-book"></i>
                    <i class="fa fa-caret-down"></i>
                </a>

                <ul class="dropdown-menu pull-right" role="menu">
                    <li>
                        <a id="bt-add-new-image" tabindex="-1" href="#">Add new...</a>
                    </li>
                    <li>
                        <a id="bt-remove-image" tabindex="-1" href="#">Remove image...</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-link">
            <i class="fa fa-link"></i> Link </label>
        <input type="text" id="node-input-link">
    </div>

    <!-- List -->

    <!-- Add Image -->
    <div id="upload-file">

        <div id="div-category" class="form-row">
            <label for="node-input-category">
                <i class="fa fa-tag"></i> Category</label>

            <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
                <div style="position: absolute; left: 0px; right: 40px;">
                    <select style="width:100%" id="node-input-category"></select>
                </div>
                <a id="bt-add-new-category" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                    <i class="fa fa-plus"></i>
                </a>
            </div>

        </div>

        <div id="new-category" class="form-row">
            <label for="node-input-newCategory">
                <i class="fa fa-tag"></i> New Category</label>
            <input type="text" id="node-input-newCategory">
        </div>

        <div class="form-row">
            <label>
                <i class="fa fa-file-image-o"></i> Add file</label>
            <!-- <input type="file" id="node-input-upload" name="fileuploadfile" style="width: 63%" accept="image/*" multiple> -->
            <input type="file" id="node-input-upload" name="fileuploadfile" style="width: 63%" accept="image/*">
            <button id="bt-upload">Upload</button>
        </div>

    </div>
    <!-- Add Image -->

    <div class="form-row">
        <div id="preview-image" align="center">
            <img id="image-preview" style="height:auto; width:400px" src="">
        </div>
    </div>

</script>

<script type="text/x-red" data-help-name="ui_image">
    IMAGE
</script>